<app-header [title]="'music_session'|t"></app-header>

<!-- Video Background -->
<div class="video-background">
      <video 
    #backgroundVideo
    class="background-video"
    autoplay
    loop
    muted
    playsinline
    [src]="getBackgroundVideoUrl()">
  </video>
  <div class="video-overlay"></div>
</div>

<!-- Hidden Audio Element -->
<audio 
  #audioPlayer
        (timeupdate)="onTimeUpdate()"
  (loadedmetadata)="onAudioLoaded()"
  (ended)="onTrackEnded()"
        (play)="onPlay()"
        (pause)="onPause()"
  [src]="currentTrack?.url">
</audio>

<section class="content">
  <!-- Activity Section -->
  <div class="activity-section">
    <!-- Show text content if selected -->
    <div class="full-text-display" *ngIf="showFullText">
      <!-- Connect Dots Game -->
      <div class="connect-dots-game" *ngIf="selectedSubActivity?.id === 'connect_dots'">
        <div class="game-instructions">
          <p>{{'connect_dots_instructions'|t}}</p>
        </div>
        <div class="canvas-container">
          <canvas #connectDotsCanvas 
                  class="connect-dots-canvas"
                  width="300" 
                  height="200"
                  (mousedown)="onCanvasMouseDown($event)"
                  (touchstart)="onCanvasTouchStart($event)"
                  (mousemove)="onCanvasMouseMove($event)"
                  (touchmove)="onCanvasTouchMove($event)"
                  (mouseup)="onCanvasMouseUp($event)"
                  (touchend)="onCanvasTouchEnd($event)">
          </canvas>
        </div>
        <div class="game-controls">
          <button class="reset-btn" (click)="resetConnectDotsGame()">{{'reset_game'|t}}</button>
        </div>
    </div>
    
      <!-- Maze Game -->
      <div class="maze-game" *ngIf="selectedSubActivity?.id === 'solve_maze'">
        <div class="game-instructions">
          <p>{{'maze_instructions'|t}}</p>
        </div>
        <div class="maze-container">
          <canvas #mazeCanvas 
                  class="maze-canvas"
                  width="300" 
                  height="200"
                  (mousedown)="onMazeMouseDown($event)"
                  (touchstart)="onMazeTouchStart($event)"
                  (mousemove)="onMazeMouseMove($event)"
                  (touchmove)="onMazeTouchMove($event)"
                  (mouseup)="onMazeMouseUp($event)"
                  (touchend)="onMazeTouchEnd($event)">
          </canvas>
        </div>
        <div class="game-controls">
          <button class="reset-btn" (click)="resetMazeGame()">{{'reset_game'|t}}</button>
        </div>
      </div>
      
      <!-- Regular text content for other activities -->
      <div class="full-text-display-content" 
           *ngIf="selectedSubActivity?.id !== 'connect_dots' && selectedSubActivity?.id !== 'solve_maze'"
           #textContent 
           (scroll)="onTextScroll($event)">
        <p>{{ getActivityText() }}</p>
      </div>
    </div>

    <!-- Show buttons if no text -->
    <div *ngIf="!showFullText">
      <!-- Activity Title -->
      <div class="activity-title-container">
        <h3 class="activity-title">{{'choose_activity'|t}}</h3>
      </div>
      
      <!-- Main Activity Buttons -->
      <div class="activity-buttons" *ngIf="!selectedActivity">
        <button class="activity-btn" (click)="selectActivity('reading')">
          <div class="activity-icon">üìñ</div>
          <span>{{'reading'|t}}</span>
        </button>
        <button class="activity-btn" (click)="selectActivity('writing')">
          <div class="activity-icon">‚úçÔ∏è</div>
          <span>{{'writing'|t}}</span>
        </button>
        <button class="activity-btn" disabled>
          <div class="activity-icon">üìä</div>
          <span>{{'changing_slides'|t}}</span>
        </button>
        <button class="activity-btn" disabled>
          <div class="activity-icon">üéØ</div>
          <span>{{'identify_objects'|t}}</span>
        </button>
      </div>

      <!-- Specific Activity Options -->
      <div class="specific-activity-section" *ngIf="selectedActivity">
               <div class="specific-activity-buttons">
                 <button 
                   *ngFor="let option of getSpecificActivityOptions()" 
                   class="specific-activity-btn"
                   [class.completed]="isActivityCompleted(selectedActivity, option.id)"
                   (click)="selectSpecificActivity(option)">
                   <div class="specific-activity-icon">{{option.icon}}</div>
                   <div class="specific-activity-content">
                     <span>{{option.name}}</span>
                     <div class="activity-progress-bar">
                       <div class="activity-progress-fill" [style.width.%]="getActivityProgress(selectedActivity, option.id)"></div>
                     </div>
                     <div class="activity-progress-text">{{getActivityProgress(selectedActivity, option.id)}}%</div>
                   </div>
                 </button>
               </div>
      </div>
    </div>
  </div>

         <!-- Congratulations Message -->
         <div class="congratulations-overlay" *ngIf="showCongratulations">
           <div class="congratulations-content">
             <div class="congratulations-icon">üéâ</div>
             <h2>{{'congratulations'|t}}</h2>
             <p>{{'activity_completed'|t}}</p>
           </div>
         </div>

  <!-- Music Player Container (includes progress bar and player) -->
  <div class="music-player-container">
    <!-- Reading Progress Bar (only shown when reading, not games) -->
    <div class="reading-progress-container" *ngIf="showFullText && selectedSubActivity?.id !== 'connect_dots' && selectedSubActivity?.id !== 'solve_maze'">
      <div class="reading-progress-label">{{'reading_progress'|t}}: {{readingProgress}}%</div>
      <div class="reading-progress-bar">
        <div class="reading-progress-fill" [style.width.%]="readingProgress"></div>
      </div>
    </div>

    <!-- Compact Music Player -->
    <div class="compact-music-player">
    
    <!-- Track Info -->
    <div class="track-info">
      <h3 class="track-title">
        <span class="title-text">{{ getTrackTitle() || 'No Track Selected' }}</span>
        <span class="separator"> - </span>
        <span class="artist-text">{{ getArtistName() || 'Unknown Artist' }}</span>
      </h3>
    </div>

    <!-- Progress Bar with Time -->
    <div class="progress-section">
      <div class="time-display">
        <!-- English: Current time on left, total time on right -->
        <ng-container *ngIf="translateService.lang === 'en'">
          <span class="current-time">{{ formatTime(currentTime) }}</span>
          <span class="total-time">{{ formatTime(duration) }}</span>
        </ng-container>
        
        <!-- Hebrew: Current time on left, total time on right -->
        <ng-container *ngIf="translateService.lang === 'he'">
          <span class="current-time">{{ formatTime(currentTime) }}</span>
          <span class="total-time">{{ formatTime(duration) }}</span>
        </ng-container>
      </div>
      <div class="progress-bar-container" (click)="seekTo($event)">
        <div class="progress-bar-track"></div>
        <div class="progress-bar-fill" [style.width.%]="progressPercentage"></div>
        <div class="progress-thumb" 
             [style.left.%]="translateService.lang === 'en' ? progressPercentage : null"
             [style.right.%]="translateService.lang === 'he' ? progressPercentage : null"></div>
      </div>
    </div>

    <!-- Music Controls -->
    <div class="music-controls">
      <!-- English (LTR): Previous - Play - Next -->
      <ng-container *ngIf="translateService.lang === 'en'">
        <button class="control-btn" (click)="previousTrack()" [disabled]="currentTrackIndex === 0">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M6 6H8V18H6V6ZM9.5 12L18 6V18L9.5 12Z" fill="currentColor" />
          </svg>
        </button>

        <button class="control-btn play-btn" (click)="togglePlayPause()">
          <svg *ngIf="!isPlaying" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M8 5V19L19 12L8 5Z" fill="currentColor" />
          </svg>
          <svg *ngIf="isPlaying" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M6 4H10V20H6V4ZM14 4H18V20H14V4Z" fill="currentColor" />
          </svg>
        </button>

        <button class="control-btn" (click)="nextTrack()" [disabled]="currentTrackIndex === playlist.length - 1">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M6 18L14.5 12L6 6V18ZM16 6V18H18V6H16Z" fill="currentColor" />
          </svg>
        </button>
      </ng-container>

      <!-- Hebrew (RTL): Previous - Play - Next -->
      <ng-container *ngIf="translateService.lang === 'he'">
        <button class="control-btn" (click)="previousTrack()" [disabled]="currentTrackIndex === 0">
          <!-- Previous button with next icon (right arrow) for RTL -->
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M6 18L14.5 12L6 6V18ZM16 6V18H18V6H16Z" fill="currentColor" />
          </svg>
        </button>

        <button class="control-btn play-btn" (click)="togglePlayPause()">
          <svg *ngIf="!isPlaying" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M8 5V19L19 12L8 5Z" fill="currentColor" />
          </svg>
          <svg *ngIf="isPlaying" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M6 4H10V20H6V4ZM14 4H18V20H14V4Z" fill="currentColor" />
          </svg>
        </button>

        <button class="control-btn" (click)="nextTrack()" [disabled]="currentTrackIndex === playlist.length - 1">
          <!-- Next button with previous icon (left arrow) for RTL -->
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M6 6H8V18H6V6ZM9.5 12L18 6V18L9.5 12Z" fill="currentColor" />
          </svg>
        </button>
      </ng-container>
  </div>
  
    </div>
  </div>

  <!-- Congratulations Message -->
  <div class="congratulations-overlay" *ngIf="showCongratulations">
    <div class="congratulations-card">
      <div class="congrats-icon">üéµ</div>
      <h2>{{'congratulations'|t}}</h2>
      <p>{{'music_session_completed'|t}}</p>
      <button class="btn-primary" (click)="goBack()">
        {{'continue'|t}}
      </button>
    </div>
  </div>

</section>
